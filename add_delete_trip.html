<!DOCTYPE html>
<html>
   <title>Taylored Instruction</title>
   <head>
      	<link rel="stylesheet" href="lib/chosen.css">
      <link rel="icon" sizes="192x192" href="images/icon.png">
      <link rel="apple-touch-icon" href="images/icon.png">
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.8.3.js"></script>
<script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.jquery.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.css">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">
      <link rel="stylesheet" href="lib/w3.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <style>
         body, h1,h2,h3,h4,h5,h6 {font-family: "Montserrat", sans-serif}
         .w3-row-padding img {margin-bottom: 12px}
         /* Set the width of the sidenav to 120px */
         .w3-sidenav {width: 120px;background: #222;}
         /* Add a left margin to the "page content" that matches the width of the sidenav (120px) */
         #main {margin-left: 120px}
         /* Remove margins from "page content" on small screens */
         @media only screen and (max-width: 600px) {#main {margin-left: 0}}
      </style>
      <style>
         body { 
         background-color: black;
         }
      </style>
      <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-database.js"></script>
      <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-messaging.js"></script>
      <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvBPL76AXVKbwSpm9X1BlXTzaTXhNLYew"></script>
      
   </head>
   <body class="w3-black">
      <script type="text/javascript">
$(function() {
    $(".chzn-select").chosen();
});
</script>

<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAPGboQdrh1wMjLi6cxhPF53NNuCdbRgBY",
    authDomain: "taylored-instruction.firebaseapp.com",
    databaseURL: "https://taylored-instruction.firebaseio.com",
    storageBucket: "taylored-instruction.appspot.com",
    messagingSenderId: "1091342339175"
  };
  firebase.initializeApp(config);
     var database = firebase.database();
   firebase.auth().onAuthStateChanged(function() {
      loadXMLDoc()
      popDeleteTrip()
      popUsers()
   });
   
function writeTripInformation() {
   var userId = firebase.auth().currentUser;
   var json = JSON.parse(localStorage.json)
   var i = document.getElementById("rivsecs").value
   var newtripref = firebase.database().ref().child('users').push().key
  firebase.database().ref('users/' + userId.uid + '/trips/' + newtripref).set({
    organiser: userId.displayName,
    uid: userId.uid,
    trip: document.getElementById("tripname").value,
    section: json.rows[i][0]+" - "+json.rows[i][1],
    date: document.getElementById("date").value,
    time: document.getElementById("time").value,
    groupsize: document.getElementById("groupsize").value,
    space: document.getElementById("groupsize").value,
    email: document.getElementById("email").value,
    phone : document.getElementById("phone").value,
    info : document.getElementById("info").value
  }, function(error){
                  if(error){
                  alert("Trip could not be added" + error)
                  }
                  else{
               }
               });
   firebase.database().ref('trips/active/' + newtripref + '/details').set({
    organiser: userId.displayName,
    uid: userId.uid,
    trip: document.getElementById("tripname").value,
    section: json.rows[i][0]+" - "+json.rows[i][1],
    date: document.getElementById("date").value,
    time: document.getElementById("time").value,
    groupsize: document.getElementById("groupsize").value,
    space: document.getElementById("groupsize").value,
    email: document.getElementById("email").value,
    phone : document.getElementById("phone").value,
    info : document.getElementById("info").value
  }, function(error){
                  if(error){
                  alert("Trip was not added" + error)
                  }
                  else{
                  alert("Trip added successfully.")
                  popDeleteTrip()
               }
               });
  firebase.database().ref('trips/active/' + newtripref + '/confirmed/'+userId.uid).set({
     name: userId.displayName,
     id: userId.uid,
     email: userId.email
  });
  firebase.database().ref('trips/active/' + newtripref + '/invited/'+userId.uid).set({
     name: userId.displayName,
     id: userId.uid,
     email: userId.email
  });
  
}
               function popUsers(){
               var list = document.getElementById('userlist');
               removeOptions(list);
               var users = new Array()
               return firebase.database().ref('users').once('value').then(function(snapshot) {
                  snapshot.forEach(function(childSnapshot) {
                     var data = childSnapshot;
                     users.push([data.val().info.name,data.val().info.uid])
                     });
        users.sort(function(a, b) { 
                  return a[0] > b[0] ? 1 : -1;
               });
               var df = document.createDocumentFragment();
               for (var i = 0; i<users.length; i++){
                  var option = document.createElement('option');
                     option.value = users[i][1];
                     option.appendChild(document.createTextNode(users[i][0]));
                     df.appendChild(option);
               }
               list.appendChild(df)
                  });
            }
</script>
            
      
      
      <!-- Icon Bar (Sidenav - hidden on small screens) -->
      <nav class="w3-sidenav w3-center w3-small w3-hide-small">
         <!-- Avatar image in top left corner -->
         <img src="images/sidebar-icon.jpg" style="width:100%">
         <a class="w3-padding-large w3-black" href="https://tayloredinstruction.github.io/">
            <i class="fa fa-home w3-xxlarge"></i>
            <p>HOME</p>
         </a>
         <a class="w3-padding-large w3-hover-black" href="#addtrip">
            <i class="fa fa-plus w3-xxlarge"></i>
            <p>ADD TRIP</p>
         </a>
         <a class="w3-padding-large w3-hover-black" href="#deltrip">
            <i class="fa fa-minus w3-xxlarge"></i>
            <p>DELETE TRIP</p>
         </a>
         
      </nav>
      <!-- Navbar on small screens (Hidden on medium and large screens) -->
      <div class="w3-top w3-hide-large w3-hide-medium" id="myNavbar">
         <ul class="w3-navbar w3-black w3-opacity w3-hover-opacity-off w3-center w3-small">
            <li class="w3-left" style="width:33.3% !important"><a href="https://tayloredinstruction.github.io/"><i class="fa fa-home w3-xxlarge"></i></a></li>
            <li class="w3-left" style="width:33.3% !important"><a href="#addtrip"><i class="fa fa-plus w3-xxlarge"></i></a></li>
            <li class="w3-left" style="width:33.4% !important"><a href="#deltrip"><i class="fa fa-minus w3-xxlarge"></i></a></li>
         </ul>
      </div>
      <!-- Page Content -->
      <div class="w3-padding-large" id="main">
         <!-- Header/Home -->
         <header class="w3-container w3-padding-32 w3-center w3-black" id="home" style="min-height:95vh">
            <h2 class="w3-text-light-grey" align = "center">Trip Management</h2>
            <p>Add and remove trips for other paddlers to join.</p>
         </header>
         <!-- Add Trip Section -->
         <script>
            function removeOptions(selectbox)
               {
                   var i;
                   for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
                   {
               	selectbox.remove(i);
                   }
               }
               function favpopulate(){
               	var json = JSON.parse(localStorage.json)
                   removeOptions(document.getElementById("rivsecs"));
                   var elm = document.getElementById('rivsecs'),
               	df = document.createDocumentFragment();
                   for (var i=0; i<json.rows.length; i++){	    
                   var div = document.createElement('div');
                   div.innerHTML= json.rows[i][1]
                     var option = document.createElement('option');
                     option.value = i;
                     option.appendChild(document.createTextNode(json.rows[i][0]+" - "+div.textContent));
                     df.appendChild(option);
                   }
                   elm.appendChild(df);
                  var userId = firebase.auth().currentUser;
   document.getElementById("userId").value=userId.displayName
                  document.getElementById("email").value=userId.email
               }
               
               function loadXMLDoc() {
                 var userId = firebase.auth().currentUser;
                 var xhttp = new XMLHttpRequest();
                 xhttp.onreadystatechange = function() {
                   if (this.readyState == 4 && this.status == 200) {
               	var json = JSON.parse(this.responseText);
                      localStorage.removeItem("json")
                      localStorage.json=JSON.stringify(json);
                   }
                 }
                 xhttp.open("GET", "https://www.googleapis.com/fusiontables/v1/query?sql=SELECT+River%2C+Section%2C+Character%2C+'Min.+Level'%2C+'Max.+Level'%2C+'Current+Level'%2C+'12+hr+Previous'%2C+'Average+Grade'%2C+'Length+(km)'%2C+'Time+(hrs)'%2C+'Shuttle+(min)'%2C+'State'%2C+'Go+or+No'%2C+'Min+Grade'%2C+'Max+Grade'%2C+'Full+Description'%2c+'LATLONG IN'%2c+'Weather'%2c+'Forecast'+FROM+1xOnTf3qaHEzBGDv0iSEihtLUMK7nIn9QV2ED17ke&key=AIzaSyAvBPL76AXVKbwSpm9X1BlXTzaTXhNLYew", true);
                 xhttp.send();
               favpopulate();
               }
            function popDeleteTrip(){
               var list = document.getElementById('deletelist');
               removeOptions(list);
               var keys = new Array()
               var trips = new Array()
               var subs = new Array()
               return firebase.database().ref('trips/active').once('value').then(function(snapshot) {
                  snapshot.forEach(function(childSnapshot) {
                     var data = childSnapshot;
                  if (data.val().details.uid === firebase.auth().currentUser.uid){
                     keys.push(data.getKey())
                     trips.push(data.val().details.trip)
                     data.forEach(function(subchildSnapshot) {
                        if(subchildSnapshot.key!="details"){
                     subchildSnapshot.forEach(function(subsubchildSnapshot){
                     subs.push(subsubchildSnapshot.key);
                      });
                        }
                           });
                           }
                  });
                  localStorage.subs=subs.join()
               var df = document.createDocumentFragment();
               for (var i = 0; i<trips.length; i++){
                  var option = document.createElement('option');
                     option.value = keys[i];
                     option.appendChild(document.createTextNode(trips[i]));
                     df.appendChild(option);
               
               }
               list.appendChild(df)
                  });
            }
            function deleteTrip(){
               var key = document.getElementById('deletelist').value
               var subs = localStorage.subs.split(",")
               console.log(subs)
               firebase.database().ref('trips/active/' + key).update({
                  confirmed: null,
                  details: null,
                  waiting: null,
                  invited: null
                  },function(error){
                  if(error){
                  alert("Trip could not be deleted" + error)
                  }
                  else{
               }
               }); 
               for( var i = 0; i<subs.length; i++){
               firebase.database().ref('users/' + subs[i] + '/trips/' + key).set(null, function(error){
                  if(error){
                  alert("Trip could not be deleted" + error)
                  }
               });
               }
                  popDeleteTrip()
            }
            
         </script>
         <div class="w3-padding-64 w3-content" id = "addtrip" style="min-height:95vh">
           <h2>Add a Trip</h2>
            <p>Trip Organiser:<br>
                          <input type="text" id="userId" value="">
            <br>
           Trip Name:<br>
           <input type="text" id="tripname" value="">
           <br>
           Section:<br>
               <select id="rivsecs" style="max-width:90%"></select>
               <br>
           Date:<br>
           <input type="date" id="date" value="">
           <br>
           Time:<br>
           <input type="time" id="time" value="">
           <br>
           Max. Group Size:<br>
           <input type="number" id="groupsize" value="">
           <br>
           Contact Email:<br>
           <input type="text" id="email" value="">
           <br>
           Contact Phone Number:<br>
           <input type="text" id="phone" value="">
           <br>
           Invite Paddlers:<br>
               <select id="userlist" class="chzn-select" multiple="true" name="faculty" style="max-width:90%"></select>
               <br>
           Additional Information:<br>
               <textarea id="info" style="width:75wh"></textarea>
           <br>
           <br><br>
           <input type="button" value="Submit" onclick="writeTripInformation()">
            </p>
         </div>
         <!-- Delete Trip Section -->
         <div class="w3-padding-64 w3-content" id = "deltrip" style="min-height:95vh">
            <h2>Delete a Trip</h2>
            <select id = "deletelist" style = "max-width:90%"></select>
            <input type = "button" value = "Delete" id = "delete" onclick = "deleteTrip()">
         </div>
         
         <!-- Footer -->
         <footer class="w3-content w3-padding-64 w3-text-grey w3-xlarge">
            <i class="fa fa-facebook-official w3-hover-text-indigo"></i>
            <i class="fa fa-instagram w3-hover-text-purple"></i>
            <i class="fa fa-snapchat w3-hover-text-yellow"></i>
            <i class="fa fa-pinterest-p w3-hover-text-red"></i>
            <i class="fa fa-twitter w3-hover-text-light-blue"></i>
            <i class="fa fa-linkedin w3-hover-text-indigo"></i>
            <p class="w3-medium">Powered by <a href="http://www.w3schools.com/w3css/default.asp" target="_blank" class="w3-hover-text-green">w3.css</a></p>
            <!-- End footer -->
         </footer>
         <!-- END PAGE CONTENT -->
      </div>
   </body>
</html>
